<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Event Stream Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        #filters {
            margin-bottom: 20px;
        }
        #eventList {
            list-style-type: none;
            padding: 0;
        }
        .event {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 10px;
            transition: background-color 0.3s ease;
        }
        .event.seen {
            opacity: 0.5;
        }
        .event-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .event-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px;
        }
        .event-label {
            font-weight: bold;
        }
        .seen-toggle {
            margin-bottom: 10px;
        }
        #pauseButton, #liftwingButton {
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #pauseButton.paused {
            background-color: #f44336;
        }
        .clickable {
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .active-filter {
            font-weight: bold;
            color: #4CAF50;
        }
        .damaging-score {
            font-weight: bold;
            margin-top: 5px;
        }
        .risk-low {
            background-color: #e6ffe6;
        }
        .risk-medium {
            background-color: #fff0e6;
        }
        .risk-high {
            background-color: #ffe6e6;
        }
    </style>
</head>
<body>
    <h1>Wikimedia Event Stream Monitor</h1>
    <div id="filters">
        <label for="domainFilter">
            Domain:
            <input type="text" id="domainFilter" name="domainFilter" placeholder="e.g., en.wikipedia.org">
        </label>
        <label for="namespaceFilter">
            Namespace:
            <input type="number" id="namespaceFilter" name="namespaceFilter" placeholder="e.g., 0 for main">
        </label>
        <label for="minorFilter">
            <input type="checkbox" id="minorFilter" name="minorFilter"> Minor edits only
        </label>
        <label for="botFilter">
            <input type="checkbox" id="botFilter" name="botFilter"> Bot edits only
        </label>
        <label for="anonymousFilter">
            <input type="checkbox" id="anonymousFilter" name="anonymousFilter"> Anonymous edits only
        </label>
        <label for="titleRegexFilter">
            Title regex:
            <input type="text" id="titleRegexFilter" name="titleRegexFilter" placeholder="e.g., ^User:">
        </label>
        <button id="applyFilters">Apply Filters</button>
        <button id="clearFilters">Clear Filters</button>
    </div>
    <div class="seen-toggle">
        <label for="hideSeenToggle">
            <input type="checkbox" id="hideSeenToggle" name="hideSeenToggle"> Hide seen entries
        </label>
    </div>
    <button id="pauseButton">Pause</button>
    <button id="liftwingButton">Apply Liftwing API</button>
    <ul id="eventList"></ul>

    <script>
        const MAX_EVENTS = 250;
        const DISPLAY_EVENTS = 50;

        let eventBuffer = [];
        let currentIndex = 0;
        const eventList = document.getElementById('eventList');
        const eventSource = new EventSource('https://stream.wikimedia.org/v2/stream/recentchange');

        const domainFilter = document.getElementById('domainFilter');
        const namespaceFilter = document.getElementById('namespaceFilter');
        const minorFilter = document.getElementById('minorFilter');
        const botFilter = document.getElementById('botFilter');
        const anonymousFilter = document.getElementById('anonymousFilter');
        const titleRegexFilter = document.getElementById('titleRegexFilter');
        const applyFiltersButton = document.getElementById('applyFilters');
        const clearFiltersButton = document.getElementById('clearFilters');
        const hideSeenToggle = document.getElementById('hideSeenToggle');
        const pauseButton = document.getElementById('pauseButton');
        const liftwingButton = document.getElementById('liftwingButton');

        let isPaused = false;
        let activeFilters = {};

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(data);
                if (!isPaused) {
                    applyFilters();
                }
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        };

        eventSource.onerror = function(error) {
            console.error('EventSource failed:', error);
        };

        function addEvent(event) {
            event.seen = false;
            if (eventBuffer.length < MAX_EVENTS) {
                eventBuffer.push(event);
            } else {
                eventBuffer[currentIndex] = event;
                currentIndex = (currentIndex + 1) % MAX_EVENTS;
            }
        }

        function applyFilters() {
            const domain = domainFilter.value.toLowerCase();
            const namespace = namespaceFilter.value ? parseInt(namespaceFilter.value) : null;
            const minor = minorFilter.checked;
            const bot = botFilter.checked;
            const anonymous = anonymousFilter.checked;
            const titleRegex = titleRegexFilter.value ? new RegExp(titleRegexFilter.value, 'i') : null;
            const hideSeen = hideSeenToggle.checked;

            const filteredEvents = eventBuffer.filter(event => {
                if (domain && !event.server_name.toLowerCase().includes(domain)) return false;
                if (namespace !== null && event.namespace !== namespace) return false;
                if (minor && !event.minor) return false;
                if (bot && !event.bot) return false;
                if (anonymous && event.user_is_anon !== undefined && !event.user_is_anon) return false;
                if (titleRegex && !titleRegex.test(event.title)) return false;
                if (activeFilters.user && event.user !== activeFilters.user) return false;
                if (activeFilters.server && event.server_name !== activeFilters.server) return false;
                if (activeFilters.type && event.type !== activeFilters.type) return false;
                return true;
            });

            displayEvents(filteredEvents.slice(-DISPLAY_EVENTS), hideSeen);
        }

        function displayEvents(events, hideSeen) {
            eventList.innerHTML = '';
            events.forEach(event => {
                if (!hideSeen || !event.seen) {
                    displayEvent(event);
                }
            });
        }

        function displayEvent(event) {
            const li = document.createElement('li');
            li.className = 'event';
            if (event.seen) {
                li.classList.add('seen');
            }

            const header = document.createElement('div');
            header.className = 'event-header';
            header.textContent = `${event.type} - ${event.title}`;
            li.appendChild(header);

            const details = document.createElement('div');
            details.className = 'event-details';
            
            const fields = [
                { label: 'Type', value: event.type, clickable: true },
                { label: 'Title', value: `<a href="${event.meta.uri}" target="_blank">${event.title}</a>` },
                { label: 'User', value: event.user, clickable: true },
                { label: 'Comment', value: event.comment },
                { label: 'Timestamp', value: new Date(event.meta.dt).toLocaleString() },
                { label: 'Bot', value: event.bot ? 'Yes' : 'No' },
                { label: 'Minor', value: event.minor ? 'Yes' : 'No' },
                { label: 'Anonymous', value: event.user_is_anon ? 'Yes' : 'No' },
                { label: 'Old Length', value: event.length?.old },
                { label: 'New Length', value: event.length?.new },
                { label: 'Old Revision', value: event.revision?.old },
                { label: 'New Revision', value: event.revision?.new },
                { label: 'Server', value: event.server_name, clickable: true },
                { label: 'Namespace', value: event.namespace },
                { label: 'Parsed Comment', value: event.parsedcomment },
                { label: 'Diff', value: `<a href="${event.meta.uri}" target="_blank">View Changes</a>` }
            ];

            fields.forEach(field => {
                const label = document.createElement('span');
                label.className = 'event-label';
                label.textContent = field.label + ':';
                details.appendChild(label);

                const value = document.createElement('span');
                if (field.clickable) {
                    value.className = 'clickable';
                    if (activeFilters[field.label.toLowerCase()] === field.value) {
                        value.classList.add('active-filter');
                    }
                    value.addEventListener('click', () => {
                        toggleFilter(field.label.toLowerCase(), field.value);
                    });
                }
                value.innerHTML = field.value !== undefined ? field.value : 'N/A';
                details.appendChild(value);
            });

            li.appendChild(details);

            const seenLabel = document.createElement('label');
            const seenCheckbox = document.createElement('input');
            seenCheckbox.type = 'checkbox';
            seenCheckbox.checked = event.seen;
            seenCheckbox.addEventListener('change', () => {
                event.seen = seenCheckbox.checked;
                li.classList.toggle('seen', event.seen);
                if (hideSeenToggle.checked) {
                    li.style.display = event.seen ? 'none' : '';
                }
            });
            seenLabel.appendChild(seenCheckbox);
            seenLabel.appendChild(document.createTextNode(' Mark as seen'));
            li.appendChild(seenLabel);

            eventList.appendChild(li);
        }

        function toggleFilter(field, value) {
            if (activeFilters[field] === value) {
                delete activeFilters[field];
            } else {
                activeFilters[field] = value;
            }
            applyFilters();
        }

        applyFiltersButton.addEventListener('click', applyFilters);
        clearFiltersButton.addEventListener('click', () => {
            activeFilters = {};
            domainFilter.value = '';
            namespaceFilter.value = '';
            minorFilter.checked = false;
            botFilter.checked = false;
            anonymousFilter.checked = false;
            titleRegexFilter.value = '';
            applyFilters();
        });
        hideSeenToggle.addEventListener('change', () => {
            const hideSeen = hideSeenToggle.checked;
            document.querySelectorAll('#eventList .event').forEach(li => {
                if (li.classList.contains('seen')) {
                    li.style.display = hideSeen ? 'none' : '';
                }
            });
        });

        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? 'Resume' : 'Pause';
            pauseButton.classList.toggle('paused', isPaused);
            if (!isPaused) {
                applyFilters();
            }
        });

        liftwingButton.addEventListener('click', applyLiftwingAPI);

        async function applyLiftwingAPI() {
            const events = Array.from(document.querySelectorAll('#eventList .event'));
            for (const eventElement of events) {
                const revisionElement = eventElement.querySelector('.event-details span:nth-child(24)');
                if (revisionElement) {
                    const revisionNew = revisionElement.textContent;
                    if (revisionNew && revisionNew !== 'N/A') {
                        try {
                            const response = await fetch('/liftwing', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ rev_id: revisionNew }),
                            });
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const data = await response.json();
                            const scores = data.enwiki.scores;
                            const revId = Object.keys(scores)[0];
                            const damagingScore = scores[revId].damaging.score.probability.true;
                            
                            const scoreElement = document.createElement('div');
                            scoreElement.className = 'damaging-score';
                            scoreElement.textContent = `Damaging Score: ${(damagingScore * 100).toFixed(2)}%`;
                            eventElement.appendChild(scoreElement);

                            // Color-code the event based on the risk level
                            if (damagingScore < 0.3) {
                                eventElement.classList.add('risk-low');
                            } else if (damagingScore < 0.7) {
                                eventElement.classList.add('risk-medium');
                            } else {
                                eventElement.classList.add('risk-high');
                            }
                        } catch (error) {
                            console.error('Error fetching Liftwing API:', error);
                            const errorElement = document.createElement('div');
                            errorElement.className = 'error-message';
                            errorElement.textContent = `Error: ${error.message}`;
                            eventElement.appendChild(errorElement);
                        }
                    }
                }
            }
        }

        applyFilters();
    </script>
</body>
</html>